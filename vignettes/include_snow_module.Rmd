---
title: "Couple a snow module to a hydrological model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Couple a snow module to a hydrological model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette shows how to couple a hydrological model with a hydrological model without a snow model.
While `snow`, `TUW` and the `airGR` models come with an own snow module (the latter just with renaming the model from `GR6J` to `CemaNeigeGR6J`), this needs a bit more coding within this package (and can be done more integrated similar to the [airGR](https://rdrr.io/cran/airGR/) package in the future). Important new parts are in *italic*.

## Preparations

### Load packages

```{r packages, include=FALSE}
library(openQUARREL)
library(dplyr)
```

```{r packages_showcode, eval=FALSE}
library(openQUARREL)
library(dplyr)
```

### Load data
```{r load data}
data(input_data)
data(basin_data)
```

### Create a minimum input
```{r minimum data}
# can be done as separate data set
minimum_input <- input_data %>% 
  filter(HSU_ID == "2303") %>% 
  select(DatesR, P, T, E)

minimum_basin_info <- basin_data[["2303"]]
# todo: delete HypsoData in general
minimum_basin_info$HypsoData <- NULL

# convert Date to POSIXct
# todo: put it into input_data already, but is also good to show it here
minimum_input$DatesR <- as.POSIXct(minimum_input$DatesR)
attr(minimum_input$DatesR, "tzone") <- "UTC"
```

### *Choose a snow module and a hydrological model (without an own snow module)*
```{r settings}
cal_par <- default_cal_par # todo: this needs to be changed
snow_module <- "CemaNeige"
model <- "sacramento"
```

### Set model parameters
```{r param}
param <- (default_cal_par[[model]]$upper + default_cal_par[[model]]$lower) / 2
print(param)
```
### *Set snow module parameters*
```{r snow param}
snow_param <- (default_cal_par[[snow_module]]$upper + default_cal_par[[snow_module]]$lower) / 2
print(snow_param)
```

### Create input 
```{r input}
# todo: check on basin_info
input <- create_input(model, minimum_input, list()) %>% 
  suppressWarnings() %>% suppressMessages()
```

### *Create snow input*
```{r snow input}
snow_input <- create_input(snow_module, minimum_input, list()) %>% 
  suppressWarnings() %>% suppressMessages()
```

## Run the model without the snow module
```{r run model}
sim <- simulate_model(model, param, input)
```

## *Run the model with the snow module*
### *Simulate snow module*
```{r simulate snow}
# simulate snow module
snow_module_results <- simulate_snow(snow_module, snow_param, snow_input) %>% 
  suppressWarnings() %>% suppressMessages()
```

Update precipitation with snow module surface water runoff
```{r update precip}
input$P <- snow_module_results$surface_water_runoff
```

### *Run the model with updated input*
```{r run_ snow module}
sim_update <- simulate_model(model, param, input)
```


Combine snow and runoff results (not required, just nice)
```{r merge results}
sim_update <- merge_snow_runoff_sim(sim_update, snow_module_results)
```

The output contains now also the snow module results `SWE`, `psolid`, `pliquid` and `melt`, and `more_info` contains a list of 2, i.e both the complete hydrological model and the snow module results with all details directly from the original package output.
```{r output}
str(sim_update)
```

## Plot results
Here is a simple plot for simulated discharge with (red) and without (black) the snow module, skipping the first ~3 years (warm-up):
```{r plot}
plot(sim$date[3*365:length(sim$date)], sim$Qsim[3*365:length(sim$date)], type = "l", main = "Simulated Discharge", ylab = "Q [mm/d]", xlab = "Date")
lines(sim_update$date[3*365:length(sim$date)], sim_update$Qsim[3*365:length(sim$date)], col="red")

```

## Next steps
Now you do this again with a different hydrological model or snow module (see table in `vignette("model_overview")`), or proceed with  `vignette("calibrate_validate")`. 

