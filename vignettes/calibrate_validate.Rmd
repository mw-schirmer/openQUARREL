---
title: "Calibration and validation"
author: "Michael Schirmer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calibration and validation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)


```


This vignette shows how to calibrate and validate a hydrological model

## Preparations

Do first vignette until (excluding) Run the model

```{r first_vignette, include=FALSE}
source("run_model_minimalistic.R")
```


## We need now additionally the hydroGOF package and observed streamflow (column Qmm).

```{r packages_new}
library(hydroGOF)

minimum_input <- input_data %>% 
  filter(HSU_ID == "2303") %>% 
  select(DatesR, Qmm) %>%
  inner_join(minimum_input, join_by(DatesR))
  

```



### split data set for warm-up, calibration and validation

``` {r split indices}
  # split data set
  split_indices <- split_data_set(
    minimum_input,
    c("1981-01-01", "1982-12-31", # warm up
      "1983-01-01", "2000-12-31", # calibration
      "2001-01-01", "2020-12-31") # validation
  )
  

```


### Calibration settings
```{r calibration_settings}

cal_fn <- "steepest_descent"

error_crit_transfo <- "KGE__none"
do_transfo_param <- TRUE
```


### put basin information in a list
todo: some redundancy with input, needs to be solved in future releases
```{r hydro_data}
hydro_data <- list()
hydro_data$BasinObs <- minimum_input
hydro_data$BasinInfo <- minimum_basin_info

```


### Calibrate the model

```{r calibrate}

# calibrate the model
calibration_results <- calibrate_model(
  hydro_data, split_indices, model, input,
  cal_fn = cal_fn, do_transfo_param = do_transfo_param
) %>% suppressWarnings() %>% suppressMessages()


```


### show calibration results

Calibration finished in `r calibration_results$duration %>% as.numeric()` sec with best criterion `r calibration_results$error_crit_val` with the model parameters:

```{r calibration_results}

print(calibration_results$model_param)


```











